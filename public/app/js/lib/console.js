define(["$","castrato","settings","templates","sounds","room","notifications","audio"],function(t,e,n,o,i){var r={chat:t("#chat"),input:t("#input"),inputWrapper:t("#input_wrapper")},s={},a={post:function(e,i,s){var c,u=o.post[e],p="msg_"+(new Date).getTime()+"_"+Math.round(1e6*Math.random()),m=Object.assign({},n,{nick:s,timestamp:(new Date).toLocaleTimeString(),id:p});m.text=t.template(i,m),c=t.template(u,m),a.showNotification(e,s,i),setTimeout(function(){var e=r.chat.first(),n=t("#"+p).first();e.removeChild(n)},n.ttl),r.chat.append(c)},torch:function(i){(i=parseInt(i))>0&&i<3600?(e.emit("console:info",t.template(o.messages.torch_is_now,{ttl:i})),n.ttl=1e3*i):e.emit("console:error",t.template(o.messages.torch_not_set))},param:function(t){s=Object.assign({},s,t)},showNotification:function(t,n,o){var r="message"!==t?"Chat-App":n,s="message"===t?"gfx/icon_128x128.png":"error"===t?"gfx/icon_128x128_error.png":"gfx/icon_128x128_info.png";e.emit("notification:send",{title:r.substring(0,20),body:o.substring(0,80),icon:s}),"message"===t&&e.emit("audio:play",i.message)},motd:function(t){a.post("motd",t)},info:function(t){a.post("info",t)},error:function(t){a.post("error",t)},server:function(t){a.post("server",t)},message:function(t){a.post("message",t.message,t.nick)},clearInput:function(){r.input[0].value=""},clear:function(){r.chat[0].innerHTML=""},lockInput:function(){r.input[0].setAttribute("disabled","disabled"),r.inputWrapper[0].className="loading"},unlockInput:function(){r.input[0].removeAttribute("disabled"),r.inputWrapper[0].className="",r.input.focus()},_require:function(t,e){a.lockInput(),a.post("info","Requiring "+t+"..."),require([t],function(){a.post("info","Successfully required "+t+"."),a.unlockInput(),e()},function(n){a.post("error",'An error occurred while trying to load "'+t+'":\n'+n),a.unlockInput(),e()})}},c=function(n){var i,c,u,p;if(!n.ctrlKey&&!n.altKey&&r.input[0]!==t.activeElement())return r.input.focus();if(13===n.keyCode&&(i=r.input[0].value))if("/"===(i[0]||i.slice(0,1)))c=t.ssplit(i.slice(1)," "),p=c[0],u=c[1],e.emit("command:"+p,u,function(e,n){if(!n)return a.post("error",t.template(o.messages.unrecognized_command,{commandName:p}));a.clearInput()});else{if(!s.room||!s.key)return s.room?a.post("error",o.messages.msg_no_key):a.post("error",o.messages.msg_no_room);e.emit("socket:emit",{data:"message:send",payload:{room:t.SHA1(s.room),msg:t.AES.encrypt(i,t.SHA1(s.room)+s.key).toString(),nick:!!s.nick&&t.AES.encrypt(s.nick,t.SHA1(s.room)+s.key).toString()}}),a.clearInput()}};t(document).on("keydown",c),r.input.focus();for(var u in a)"_require"!==u&&"post"!==u&&e.on("console:"+u,a[u]);e.on("console:require",a._require),e.on("console:post",function(t){a.post(t.type,t.data,t.nick)})});