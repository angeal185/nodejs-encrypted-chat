define(["$","castrato","settings","templates","hosts","window"],function(e,o,n,t,s){var c,i,m={},r=function(e){c&&c.emit(e.data,e.payload)},a=function(){o.emit("info",JSON.stringify(i||{}))},l=function(n,c){var i,m=0,r=s.hosts.length,a="\n",l=function(n,s,i){return function(m){n.settings=i?m:0,a+=e.template(t.messages[i?"host_available":"host_unavailable"],{name:n.name,path:n.path,index:s}),0==--r&&(o.emit("console:info",a),c())}};for(n=n&&"force"===n.toLowerCase();i=s.hosts[m];)n||void 0===i.settings?require([i.path],l(i,m,1),l(i,m,0)):i.settings?l(i,m,1)():l(i,m,0)(),m++},d=function(r,a){o.emit("console:lockInput");var l;if(r=void 0===r?s.autoconnect:r,i&&i.connected)return o.emit("console:error",e.template(t.messages.already_connected,{host:i.name||"localhost"})),void o.emit("console:unlockInput");if(e.isDigits(r)){if(!(i=s.hosts[+r]))return o.emit("console:error","Undefined host index: "+r),void o.emit("console:unlockInput");i.settings?n=i.settings:l=i.path}else r?l=r.settings:n=r.settings;if(l)return require([l],function(e){return i.settings=e,d(r,a)},function(){o.emit("console:error","Could not fetch host settings: "+l),o.emit("console:unlockInput")});o.emit("console:info",e.template(t.messages.connecting,{host:i.name||"localhost"})),o.emit("console:motd",i.settings.motd),(c=e.io(i.host,{forceNew:!0,"force new connection":!0})).on("room:joined",function(){o.emit("console:info",e.template(t.messages.joined_room,{roomName:e.escapeHtml(m.room)})),c.emit("room:count")}).on("room:left",function(){o.emit("console:info",e.template(t.messages.left_room,{roomName:e.escapeHtml(m.room)})),o.emit("room:changed",!1)}).on("message:send",function(n){var s=e.AES.decrypt(n.msg,e.SHA1(m.room)+m.key),c=e.escapeHtml(s),i=n.nick?e.escapeHtml(e.AES.decrypt(n.nick,e.SHA1(m.room)+m.key)):t.default_nick;s?o.emit("console:message",{message:c,nick:i}):o.emit("console:error",t.messages.unable_to_decrypt)}).on("message:server",function(n){if(n.msg){var s=e.escapeHtml(n.msg);if(t.server[s])if(void 0!==n.payload){var c=e.escapeHtml(n.payload);o.emit("console:server",e.template(t.server[s],{payload:c}))}else o.emit("console:server",t.server[s]);else o.emit("console:error",t.server.bogus)}else o.emit("console:error",t.server.bogus)}).on("connect",function(){o.emit("console:info",e.template(t.messages.connected,{host:i.name||"localhost"})),o.emit("window:title",i.settings.title),o.emit("console:unlockInput"),a(),i.connected=1}).on("disconnect",function(){i.connected=0,o.emit("console:info",e.template(t.messages.disconnected,{host:i.name||"localhost"})),o.emit("room:changed",void 0),o.emit("window:title",t.client.title)}).on("connect_error",function(){i.connected=0,o.emit("console:error",t.messages.socket_error),o.emit("console:unlockInput")})},u=function(e,n){if(!i)return n(),o.emit("console:error",t.messages.reconnect_no_host);i.connected?(f(),d(i,n)):d(i,n)},f=function(){c.disconnect()},g=function(e){m=Object.assign({},m,e)};o.on("command:host",a),o.on("command:hosts",l),o.on("command:connect",d),o.on("command:disconnect",f),o.on("command:reconnect",u),o.on("socket:emit",r),o.on("host:param",g)});